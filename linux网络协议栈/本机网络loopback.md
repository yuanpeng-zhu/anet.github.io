# 本机网络（`loopback`）

本机网络（`loopback`）与跨机网络的主要区别在于数据包的传输路径和处理方式。**本机网络（`loopback`）的数据包无需经过物理网络设备，而是直接通过内核在本地进行传输和处理，这意味着数据包不会真正离开主机，只是在内核中完成从发送到接收的过程，因此传输效率更高，延迟更低**。跨机网络则需要通过实际的物理网络设备（如网卡）将数据包发送到外部网络，并经过路由、交换机等设备的转发，最终到达另一台主机。跨机网络的数据包传输受制于网络拓扑、带宽、路由路径、传输延迟等因素，处理相对复杂且开销较大。简而言之，本机网络在同一主机内部完成数据包的转发，而跨机网络涉及多个物理设备和网络节点之间的数据传递。

## 一、网络层区别

当数据发送进入协议栈并到达网络层时，网络层的入口函数是 `ip_queue_xmit`。在网络层中，数据包会首先进行路由选择。路由选择完成后，网络层会对数据包的头部（Header）进行设置，并通过 `netfilter` 进行过滤操作。过滤完成后，数据包会被交给邻居子系统（Neighbor Subsystem）进一步处理。
对于本地网络回环接口 `lo` 来说，其特殊性在于：路由选择会在本地路由表 `local` 中找到匹配的路由项，且所有匹配项都会使用回环网卡（即 `loopback` 设备），这就是我们通常所说的 `lo` 设备。
数据在`__ip_queue_xmit()`函数中调用`ip_route_output_ports()`函数查找路由表项。
最终调用`fib_lookup()`，该函数会先查询local表，然后查询main表。
本地网络查询到local表即终止返回。
### 注：
通过`ip route list table 1ocal`可以查询local表
通过`route -n`可查询全部路由表
原理：新版的 `route` 命令或 `ip` 命令通常会使用 `Netlink` 接口来查询内核中的路由表信息。`Netlink` 是 Linux 内核与用户空间之间的通信机制，允许用户查询和操作内核中存储的路由表。

通过查询路由表，获取对应的发送设备，本机网络即`net->loopback_dev`。
区别：IP分片：物理网卡MTU仅为1500，本地网卡为65535.
接下来进入`ip_finish_output`,进入邻居子系统进行处理。

## 二、设备层区别

网络设备子系统的数据包发送入口函数是 `dev_queue_xmit`。在前面介绍跨主机数据发送的过程中提到，对于具有硬件队列的物理设备，该函数会经过一系列复杂的排队和处理操作，然后再调用 `dev_hard_start_xmit` 函数。
`dev_hard_start_xmit` 负责将数据包交给设备驱动程序进行实际的发送。
对于本地网络，调用loopback驱动的`1oopback_xmit()`发送数据。
`1oopback_xmit`中直接调用`netif_rx(skb)`相当于把发送的skb直接用于接收，省去了拷贝的开销。






