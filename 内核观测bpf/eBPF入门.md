## eBPF（Extended Berkeley Packet Filter）

eBPF（扩展型伯克利数据包过滤器）是 Linux 内核的一项强大功能，它允许开发者在内核中运行用户定义的代码，而不需要修改内核源代码或重新编译内核。eBPF 是 Linux 内核的一种机制，它提供了一种灵活、安全且高效的方式来扩展内核功能，尤其是在网络、性能监控、系统跟踪、调试等场景中。

eBPF 最早用于网络包过滤（Berkeley Packet Filter，BPF），但它经过扩展后，可以在内核中执行多种类型的操作，包括跟踪、调试、性能监控、流量管理等。eBPF 程序是以“钩子”的形式附加到内核的各个部分（如网络栈、文件系统、进程调度等）进行执行。

### eBPF 的功能

1. **网络性能监控和过滤**：
   - eBPF 允许你创建高效的程序，在网络栈的不同层次进行数据包处理。例如，XDP（eXpress Data Path）是一个基于 eBPF 的高效数据包过滤框架，允许在网卡驱动层直接处理和过滤网络流量。
   - eBPF 可用于监控网络流量、过滤流量、阻止恶意流量或进行负载均衡等。

2. **系统跟踪和性能分析**：
   - eBPF 通过跟踪系统调用、内核函数、网络协议栈等，提供细粒度的系统监控。常见的工具如 `bpftrace`、`perf` 和 `trace` 都是基于 eBPF 的。
   - 你可以使用 eBPF 程序捕捉内核事件，并分析它们的性能，如 CPU 使用率、内存分配、磁盘 I/O 等。

3. **安全性**：
   - eBPF 可以用于实现内核级别的安全检测，例如入侵检测、恶意流量阻止等。eBPF 程序可以在系统调用层进行监控，检测潜在的攻击模式或非法访问。

4. **流量控制与调度**：
   - eBPF 允许用户编写代码控制网络流量。可以在 TCP、UDP、HTTP 等协议的不同层次处理数据包，实现流量整形、流量管理等功能。

5. **调试和故障排查**：
   - eBPF 程序能够以非常低的开销在内核中运行，可以用于收集系统事件、追踪函数调用等，帮助开发者调试和分析内核行为。

### eBPF 程序类型

eBPF 程序可以附加到内核中的多个“钩子”点，根据不同的用途和应用场景，eBPF 程序可以分为以下几类：

1. **BPF 程序**：
   - 用于网络包过滤，最初是设计用于包过滤，通常与 `tc` 命令结合使用，作为 Linux 内核中的流量控制工具。
   - eBPF 程序可以附加在网络接口卡（NIC）上，用于过滤、修改或丢弃数据包。

2. **XDP（eXpress Data Path）**：
   - 一种更高效的包过滤和处理机制，它允许在网络接口驱动程序层（NIC）进行包的快速处理。XDP 提供比传统的 Linux 网络栈更低的延迟和更高的吞吐量。
   - XDP 可以通过 eBPF 程序处理包并根据需要修改或丢弃包，具有显著的性能优势。

3. **Tracepoint**：
   - eBPF 可以附加到内核中的 tracepoint，用于跟踪内核事件。例如，内核中的函数调用、系统调用、网络事件等可以通过 tracepoint 进行监控。

4. **Kprobe / Uprobe**：
   - Kprobe 允许在内核函数调用时插入代码，用于调试、性能监控或故障排查。
   - Uprobe 允许在用户空间的函数调用时插入代码。

5. **cgroup（控制组）**：
   - eBPF 可以用于 cgroup 的钩子，监控和控制进程的资源使用情况，如 CPU、内存等。

6. **Perf Events**：
   - eBPF 程序可以与 `perf` 事件一起使用，用于收集和分析性能数据。

7. **Socket Filter**：
   - eBPF 程序也可以作为 socket filter 使用，用于过滤通过 socket 发送的数据。

8. **Tracepoint / raw_tracepoint**：
   - eBPF 可以通过 raw tracepoint 捕获内核中更低级别的事件，或者直接通过 tracepoint 捕获高层次的事件。

### eBPF 程序的工作流程

1. **编写 eBPF 程序**：
   - 使用 C 语言编写 eBPF 程序，程序通常是一个内核代码片段，运行在内核态。eBPF 程序会被编译成内核能够执行的 BPF 字节码。

2. **加载 eBPF 程序**：
   - 编译后的 eBPF 程序通过 libbpf 或其他工具加载到内核中。内核会验证 eBPF 程序，确保它的安全性和正确性。

3. **附加到内核钩子**：
   - 程序可以附加到不同的内核钩子（如 XDP、tc、tracepoints、kprobes 等）进行执行。

4. **运行 eBPF 程序**：
   - 一旦 eBPF 程序附加到钩子上，它就会根据触发条件自动执行，例如当有数据包到达网络接口时，XDP 程序就会被触发。

5. **返回数据**：
   - eBPF 程序可以将结果数据返回给用户空间，用户空间可以根据这些数据做进一步处理和分析。通常，这些数据通过 `perf_event` 或 `ring buffer` 等机制传输。

### eBPF 程序的安全性

由于 eBPF 代码运行在内核空间，它必须满足严格的验证要求，以确保不引入不安全的操作。例如：

- **类型安全**：eBPF 程序必须保证类型安全，不能访问未初始化的内存。
- **无环**：eBPF 程序在执行时不能引起内核的无限循环。
- **限制的指令集**：eBPF 程序只能使用特定的指令集，不能执行任何非安全操作，如访问内存映射 I/O 等。

### 常用的 eBPF 工具和框架

1. **`bpfcc-tools`**：
   - 一组基于 eBPF 的工具，提供对内核的实时性能分析。包含许多有用的跟踪工具，如 `execsnoop`、`tcplife` 等。

2. **`bpftrace`**：
   - 类似于 `dtrace`，`bpftrace` 是一个基于 eBPF 的跟踪工具，允许用户编写简单的脚本来监控系统和应用程序行为。通过简洁的语法，`bpftrace` 允许用户以非常低的开销进行跟踪和分析。

3. **`XDP`**：
   - 一个基于 eBPF 的高速数据包处理框架，允许在内核中高速处理数据包，避免经过内核网络栈。

4. **`libbpf`**：
   - 这是一个 C 库，用于加载、验证、附加和管理 eBPF 程序。它是与 eBPF 交互的主要接口。

5. **`bpftool`**：
   - 一个用于查看、调试和管理 eBPF 程序和 BPF map 的命令行工具。


### 相关参考资料
1. [eBPF 开发实践教程](https://eunomia.dev/zh/tutorials/)
2. [linux内核观测bpf](https://www.oreilly.com/library/view/linux-bpf/9787111660545/)
3. [eBPF学习实践系列](https://xiaodongq.github.io/category/#eBPF)

